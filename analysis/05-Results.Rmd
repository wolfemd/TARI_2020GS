---
title: "Results"
site: workflowr::wflow_site
date: "2020-October-15"
output: 
  workflowr::wflow_html:
    code_folding: hide
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = F, tidy = T)
```

# Raw data

Summary of the number of unique plots, locations, years, etc. in the cleaned plot-basis data. See [here](01-cleanTPdata.html) for details..
```{r}
library(tidyverse); library(magrittr);
rawdata<-readRDS(file=here::here("output","TARI_ExptDesignsDetected_2020Dec18.rds"))
rawdata %>% 
  summarise(Nplots=nrow(.),
            across(c(locationName,studyYear,studyName,TrialType,GID), ~length(unique(.)),.names = "N_{.col}")) %>% 
  rmarkdown::paged_table()
```

So ~3700 unique clone names in the phenotype data, across >12K plots. This _is not_ the same number of clones as are expected to be genotyped-and-phenotyped.

Break down the plots based on the trial design and TrialType (really a grouping of the population that is breeding program specific), captured by two logical variables, **CompleteBlocks** and **IncompleteBlocks**.  
```{r}
rawdata %>% 
  count(TrialType,CompleteBlocks,IncompleteBlocks) %>% 
  spread(TrialType,n) %>% 
  rmarkdown::paged_table()
```

Next, look at breakdown of plots by TrialType (rows) and locations (columns):
```{r, cols.print=16}
rawdata %>% 
  count(locationName,TrialType) %>% 
  spread(locationName,n) %>% 
  rmarkdown::paged_table()
```

```{r, fig.width=10}
traits<-c("MCMDS","MCBSDS","CBSDRS","CGMS1","CGMS2","DM","PLTHT","HI",
          "logDYLD", "logFYLD","logTOPYLD","logRTNO")
rawdata %>% 
  select(locationName,studyYear,studyName,TrialType,any_of(traits)) %>% 
  pivot_longer(cols = any_of(traits), values_to = "Value", names_to = "Trait") %>% 
  ggplot(.,aes(x=Value,fill=Trait)) + geom_histogram() + facet_wrap(~Trait, scales='free') + 
  theme_bw() + scale_fill_viridis_d() + 
  labs(title = "Distribution of Raw Phenotypic Values")
```
How many genotyped-and-phenotyped clones?

```{r}
rawdata %>% 
  select(locationName,studyYear,studyName,TrialType,germplasmName,FullSampleName,GID,any_of(traits)) %>% 
  pivot_longer(cols = any_of(traits), values_to = "Value", names_to = "Trait") %>%
  filter(!is.na(Value),!is.na(FullSampleName)) %>%
  distinct(germplasmName,FullSampleName,GID) %>% 
  rmarkdown::paged_table()
```
There are 423 so far. 

```{r}
rawdata %>% 
  select(locationName,studyYear,studyName,TrialType,germplasmName,FullSampleName,GID,any_of(traits)) %>% 
  # pivot_longer(cols = any_of(traits), values_to = "Value", names_to = "Trait") %>% 
  # filter(!is.na(Value)) %>% 
  distinct(germplasmName,FullSampleName,GID) %>% 
  rmarkdown::paged_table()
```

Table of germplasmName-DNA-sample-name matches are here: `output/germplasmName_to_DNAname_matches_TARI_2020Dec22.csv`.

List of DNA-sample-names are here:  

1. RefPanel (containing TARI TP): `output/rownames_DosageMatrix_ImputationReferencePanel_StageVI_91119.csv`
2. New samples (DCAs20-5629): `output/rownames_DosageMatrix_DCas20_5629_EA_REFimputedAndFiltered.csv`

# BLUPs

These are the BLUPs combining data for each clone across trials/locations _without_ genomic information, used as input for genomic prediction downstream.

```{r, message=F, rows.print=12}
library(tidyverse); library(magrittr);
source(here::here("code","gsFunctions.R"))
dbdata<-readRDS(here::here("output","TARI_ExptDesignsDetected_2020Dec18.rds"))
traits<-c("MCMDS","MCBSDS","CBSDRS","CGMS1","CGMS2","DM","PLTHT","HI",
          "logDYLD", "logFYLD","logTOPYLD","logRTNO")
blups<-readRDS(file=here::here("output","tari_blupsForModelTraining_twostage_asreml_2020Dec20.rds")) 

blups %>% 
  left_join(nestDesignsDetectedByTraits(dbdata,traits) %>% 
  mutate(Nplots=map_dbl(MultiTrialTraitData,nrow)) %>% 
    select(Trait,Nplots)) %>% 
  mutate(Nclones=map_dbl(blups,~nrow(.)),
         NoutliersRemoved=map2_dbl(outliers1,outliers2,~length(.x)+length(.y))) %>% 
  #relocate(c(Nclones,NoutliersRemoved),.after = Trait) %>% 
  #select(-blups,-varcomp,-outliers1,-outliers2) %>% 
  select(Trait,Nplots,Nclones,NoutliersRemoved,Vg,Ve,H2) %>% 
  mutate(across(is.numeric,~round(.,4))) %>% arrange(desc(H2)) %>% 
  rmarkdown::paged_table()
```

```{r, fig.width=10}
blups %>% 
  select(Trait,blups) %>% 
  unnest(blups) %>% 
  ggplot(.,aes(x=drgBLUP,fill=Trait)) + geom_histogram() + facet_wrap(~Trait, scales='free') + 
  theme_bw() + scale_fill_viridis_d() + 
  labs(title = "Distribution of de-regressed BLUP Values")
```

```{r, fig.width=10}
blups %>% 
  select(Trait,blups) %>% 
  unnest(blups) %>% 
  ggplot(.,aes(x=REL,fill=Trait)) + geom_histogram() + facet_wrap(~Trait, scales='free') + 
  theme_bw() + scale_fill_viridis_d() + 
  labs(title = "Distribution of BLUP Reliabilities")
```
# Prediction accuracy.

3. [Check prediction accuracy](08-CrossValidation.html): Evaluate prediction accuracy with cross-validation.
    * Compare prediction accuracy with vs. without IITA's training data to augment.

```{r}
rm(list=ls());gc()
library(tidyverse); library(magrittr); 
cv<-readRDS(here::here("output","cvresults_A_2020Dec21.rds")) %>% 
  bind_rows(readRDS(here::here("output","cvresults_ADE_2020Dec21.rds"))) %>% 
  unnest(CVresults) %>% 
  select(-splits,-accuracy)
traits<-c("MCMDS","MCBSDS","CBSDRS","CGMS1","CGMS2","DM","PLTHT","HI",
          "logDYLD", "logFYLD","logTOPYLD","logRTNO")
cv %<>% 
  mutate(Trait=factor(Trait,levels=traits),
         modelType=factor(modelType,levels=c("A","ADE")))
```

## Table of mean accuracies
```{r, rows.print=12}
cv %>% 
  group_by(Trait) %>% 
  # use accGETGV. For modelA we GETGV==GEBV. For modelADE we don't want GEBV, just GETGV.
  summarize(meanAccuracy=mean(accGETGV,na.rm=T),
            lower5pct=quantile(accGETGV,probs = c(0.05),na.rm=T),
            upper5pct=quantile(accGETGV,probs = c(0.95),na.rm=T)) %>% 
  mutate(across(is.numeric,~round(.,2))) %>% arrange(desc(meanAccuracy)) %>% 
  rmarkdown::paged_table()
```

## Boxplot of accuracies

```{r, fig.width=10, fig.height=5}
cv %>% 
  ggplot(.,aes(x=Trait,y=accGETGV,fill=modelType)) + 
  geom_boxplot(position = "dodge2",color='gray50',size=0.5) + 
  geom_hline(yintercept = 0, color='darkred') + 
#  facet_wrap(~GroupName,nrow=1,scales='free_x') + 
  theme_bw() + 
  theme(strip.text.x = element_text(face='bold', size=12),
        axis.text.y = element_text(face='bold', size=14, angle = 0),
        axis.text.x = element_text(face='bold', size=10, angle = 0),
        axis.title.y = element_text(face='bold', size=12),
        plot.title = element_text(face='bold'),
        legend.position = 'bottom') + 
  scale_fill_viridis_d() + # coord_flip() + 
  labs(title="Prediction Accuracies", y="GEBV or GETGV accuracy",x=NULL) +
  geom_hline(yintercept = 0, color='darkred')
```

